% Функция atmgost предназначена для вычисления плотности атмосферы по
% ГОСТ Р 25645.166-2004
%
% Ограничения - высота h>=500 км 
%
% F107 F81 Kp здесь ftp://ftp.kiam1.rssi.ru/pub/gps/solar/solarinex.txt
% http://www.kiam1.rssi.ru/~den/solar.html
%
% Автор: Николаев ДА    Yaliny      16.04.2015
%
% Входы:
% r - радиус-вектор точки пространства, км
% h - высота над поверхностью общеземного эллипсоида, км
% d - число суток от начала года
% t - всемирное время, c
% S - звездное время в гринвичскую полночь, рад
% rtasc - прямое восхождение Солнца, рад
% decl - склонение Солнца, рад
% F107 - Индекс солнечной активности, 10^-22 Вт/(м2*Гц)
% F81 - средневзвешенный индекс солнечной активности за 81 день, 10^-22 Вт/(м2*Гц)
% Kp -квазилогарифмический планетарный среднесуточный индекс геомагнитной
% возмущенности, баллы

% Выходы:
% Rho - плотность атмосферы, кг/м3

function [Rho, RhoN, KK]=atmgost(r,h,d,t,S,rtasc,decl,F107,F81,Kp)


% F0 - фиксированный уровень солнечной активности, 10^-22 Вт/(м2*Гц):
%       [75 100 125 150 175 200 250]
if(F81<=75)||(F81>=250)
    disp('Error in F81, it must be from 75 to 250');
    return;
end;
i=round(F81/25)-2;
F0=[75 100 125 150 175 200 250];
% Значения коэффициентов для высотного диапазона 500-1500 км
% |Коэффициент|Значение при i=1..8|
ah=[500 500 500 500 500 500 500];
a0=[17.8781 -2.54909 -13.9599 -23.3079 -14.7264 -4.912 -5.40952];
a1=[-0.132025 0.0140064 0.0844951 0.135141 0.0713256 0.0108326 0.00550749];
a2=[0.000227717 -0.00016946 -0.000328875 -0.000420802 -0.000228015 -8.10546e-5 -3.78851e-5];
a3=[-2.2543e-7 3.27196e-7 5.05918e-7 5.73717e-7 2.8487e-7 1.15712e-7 2.4808e-8];
a4=[1.33574e-10 -2.8763e-10 -3.92299e-10 -4.03238e-10 -1.74383e-10 -8.13296e-11 4.92183e-12];
a5=[-4.50458e-14 1.22625e-13 1.52279e-13 1.42846e-13 5.08071e-14 3.04913e-14 -8.65011e-15];
a6=[6.72086e-18 -2.05736e-17 -2.35576e-17 -2.01726e-17 -5.34955e-18 -4.94989e-18 1.9849e-18];
bh=[600 600 760 800 860 900 1000];
b0=[23.1584 33.2732 39.1961 43.2469 49.5738 11.278 -52.6184];
b1=[-0.0802147 -0.111099 -0.12352 -0.126973 -0.138613 0.00143478 0.214689];
b2=[0.000105824 0.000141421 0.000149015 0.000142637 0.000147851 -3.69846e-5 -0.000294882];
b3=[-6.15036e-8 -7.94952e-8 -7.9705e-8 -7.09985e-8 -6.96361e-8 3.58318e-8 1.71171e-7];
b4=[1.32453e-11 1.65836e-11 1.58772e-11 1.31646e-11 1.21595e-11 -9.91225e-12 -3.60582e-11 ];
ch=[640 700 760 820 860 860 920 980];
c0=[50.5034 61.624 53.2623 18.2236 -31.8442 -48.7208 -147.859];
c1=[-0.170541 -0.192967 -0.144342 -0.00840024 0.168327 0.222996 0.531652];
c2=[2.17232e-4 2.28061e-4 1.4659e-4 -3.88e-5 -2.62603e-4 -3.21884e-4 -671937e-4];
c3=[-1.21902e-7 -1.18715e-7 -6.46443e-8 4.31384e-8 1.65454e-7 1.91495e-7 3.64787e-7];
c4=[2.54037e-11 2.229638e-11 1.04227e-11 -1.23832e-11 -3.69355e-11 -4.08067e-11 -7.26268e-11];
n0=[2.058 2.058 2.058 2.058 2.058 2.058 2.058];
n1=[5.887e-3 5.887e-3 5.887e-3 5.887e-3 5.887e-3 5.887e-3 5.887e-3];
n2=[-4.012e-6 -4.012e-6 -4.012e-6 -4.012e-6 -4.012e-6 -4.012e-6 -4.012e-6];
fi1=[0.5411 0.5515 0.5585 0.5585 0.5585 0.5585 0.5585];
dh=[1500 1500 1500 1500 1500 1500 1500];
d0=[-0.351899 -0.047813 0.20981 0.265174 0.23047 0.170074 0.088141];
d1=[0.00577056 0.00380813 0.00262881 0.00275836 0.00338331 0.00406131 0.00468253];
d2=[9.95819e-7 4.22771e-6 4.24379e-6 2.08668e-6 -5.52305e-7 -2.82114e-6 -4.24609e-6];
d3=[-7.25324e-9 -8.66826e-9 -6.67328e-9 -3.69543e-9 -8.23607e-10 1.38369e-9 2.53509e-9];
d4=[2.9759e-12 3.06712e-12 2.13496e-12 1.11862e-12 2.21349e-13 -4.27908e-13 -7.29031e-13];
eh=[600 700 780 800 800 900 760];
e0=[38.6199 51.249 68.4746 58.422 7.20188 21.5948 -88.4076];
e1=[-0.132147 -0.167373 -2.15659e-1 -1.66664e-1 2.16109e-2 -2.02239e-2 0.338518];
e2=[1.75411e-4 2.11832e-4 2.62273e-4 1.85486e-4 -6.52882e-5 -1.72029e-5 -0.000445581];
e3=[-1.02417e-7 -1.18221e-7 -1.40972e-7 -9.12345e-8 5.37077e-8 2.83017e-8 2.51729e-7];
e4=[2.21446e-11 2.45055e-11 2.82285e-11 1.67118e-11 -1.4095e-11 -8.94486e12 -5.203e-11];
e5=[-0.20670 -0.16971 -0.14671 -0.13150 -0.120916 -0.11363 -0.10444];
e6=[9.7533e-2 7.9830e-2 6.8808e-2 6.1603e-2 5.6538e-2 5.3178e-2 4.8551e-2];
e7=[-1.1817e-2 -9.4393e-3 -7.9836e-3 -7.0866e-3 -6.4324e-3 -6.0439e-3 -5.3567e-3];
e8=[1.6145e-3 1.2622e-3 1.0535e-3 9.2813e-4 8.3723e-4 7.7982e-4 6.8809e-4];
lh=[640 660 740 800 860 900 900];
l0=[48.6536 54.4867 60.1267 47.0996 50.6174 8.01942 -15.5728];
l1=[-0.170291 -0.178298 -0.183144 -0.12526 -0.129047 0.0185302 9.36704e-2];
l2=[2.26242e-4 2.22725e-4 2.12481e-4 1.26352e-4 1.24842e-4 -6.14733e-5 -1.490366e-4];
l3=[-1.32032e-7 -1.227e-7 -1.08598e-7 -5.51584e-8 -5.24993e-8 4.97674e-8];
l4=[2.85193e-11 2.51316e-11 2.0571e-11 8.75272e-12 8.08282e-12 -1.26162e-11 -2.0961e-11];
% Планетарный среднесуточный индекс геомагнитной возмущенности с линейной
% шкалой, 2 нанотесла (2 гамма)
A0=-2.53418e-2;
A1=-2.44075e-3;
A2=3.08389e-6;
A3=2.90115e-6;
A4=-4.99606e-8;
A5=3.36327e-10;
A6=-1.0966e-12;
A7=1.73227e-15;
A8=-1.06271e-18;
% Угловая скорость вращения Земли
OmegaE=7.292114e-5;
% Плотность ночной атмосферы на высоте 120 км, кг/м3
Rho0=1.58868e-8;
% Влияние полугодового эффекта
A=A0+A1*d+A2*d^2+A3*d^3+A4*d^4+A5*d^5+A6*d^6+A7*d^7+A8*d^8;


beta=rtasc-S-OmegaE*t+fi1(i);
cosfi=1/norm(r)*(r(3)*sin(decl)+cos(decl)*(r(1)*cos(beta)+r(2)*sin(beta)));
% % Из-за ошибок округления cos(fi) быть > 1, введем ограничение
% if (abs(cosfi)-1)>1e-4
% 	disp('Something wrong in cos(fi)')
% 	return;
% elseif (abs(cosfi)-1)>0
% 	cosfi=sign(cosfi);
% end;
RhoN=Rho0*exp(a0(i)+a1(i)*h+a2(i)*h^2+a3(i)*h^3+a4(i)*h^4+a5(i)*h^5+a6(i)*h^6);
K0=1+(l0(i)+l1(i)*h+l2(i)*h^2+l3(i)*h^3+l4(i)*h^4)*(F81-F0(i))/F0(i);
K1=(c0(i)+c1(i)*h+c2(i)*h^2+c3(i)*h^3+c4(i)*h^4)*(sqrt(0.5+0.5*cosfi))^(n0(i)+n1(i)*h+n2(i)*h^2);
K2=(d0(i)+d1(i)*h+d2(i)*h^2+d3(i)*h^3+d4(i)*h^4)*A;
K3=(b0(i)+b1(i)*h+b2(i)*h^2+b3(i)*h^3+b4(i)*h^4)*(F107-F81)/(F81+abs(F107-F81));
K4=(e0(i)+e1(i)*h+e2(i)*h^2+e3(i)*h^3+e4(i)*h^4)*(e5(i)+e6(i)*Kp+e7(i)*Kp^2+e8(i)*Kp^3)
KK = [K0, K1, K2, K3, K4];
Rho=RhoN*K0*(1+K1+K2+K3+K4);
