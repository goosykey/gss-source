% Функция atmgost предназначена для вычисления плотности атмосферы по
% ГОСТ Р 25645.166-2004
%
% Ограничения - высота h>=500 км 
%
% F107 F81 Kp здесь ftp://ftp.kiam1.rssi.ru/pub/gps/solar/solarinex.txt
%
% Автор: Николаев ДА    Yaliny      16.04.2015
%
% Входы:
% r - радиус-вектор точки пространства, км
% h - высота над поверхностью общеземного эллипсоида, км
% d - число суток от начала года
% <БОЛЬШЕ НЕТУ> t - всемирное время, c
% Snew - звездное время НА ГРИНВИЧЕ ТЕКУЩЕЕ, рад
% rtasc - прямое восхождение Солнца, рад
% decl - склонение Солнца, рад
% F107 - Индекс солнечной активности, 10^-22 Вт/(м2*Гц)
% F81 - средневзвешенный индекс солнечной активности за 81 день, 10^-22 Вт/(м2*Гц)
% Kp -квазилогарифмический планетарный среднесуточный индекс геомагнитной
% возмущенности, баллы

% Выходы:
% Rho - плотность атмосферы, кг/м3

function [Rho, RhoN, KK]=atmgost2(r,h,d,Snew,rtasc,decl,F107,F81,Kp)


% F0 - фиксированный уровень солнечной активности, 10^-22 Вт/(м2*Гц):
%       [75 100 125 150 175 200 250]
if(F81<=63)||(F81>=250)
    disp('Error in F81, it must be from 75 to 250');
    return;
end
i=round(F81/25)-2;
F0=[75 100 125 150 175 200 250];
% Значения коэффициентов для обоих высотных диапазонов
% |Коэффициент|Значение при i=1..8|
ah=[500 500 500 500 500 500 500];
a0=[26.8629	27.4598	28.6395	29.6418	30.1671	29.7578	30.7854
    17.8781 -2.54909 -13.9599 -23.3079 -14.7264 -4.912 -5.40952];
a1=[-0.451674	-0.463668	-0.490987	-0.514957	-0.527837	-0.517915	-0.545695
    -0.132025 0.0140064 0.0844951 0.135141 0.0713256 0.0108326 0.00550749];
a2=[0.00290397	0.002974	0.00320649	0.00341926	0.00353211	0.00342699	0.00370328
    0.000227717 -0.00016946 -0.000328875 -0.000420802 -0.000228015 -8.10546e-5 -3.78851e-5];
a3=[-1.069530E-05	-1.075300E-05	-1.168100E-05	-1.257850E-05	-1.302270E-05	-1.241370E-05	-1.370720E-05
    -2.2543e-7 3.27196e-7 5.05918e-7 5.73717e-7 2.8487e-7 1.15712e-7 2.4808e-8];
a4=[2.21598E-08	2.17059E-08	2.36847E-08	2.57270E-08	2.66455E-08	2.48209E-08	2.80614E-08
    1.33574e-10 -2.8763e-10 -3.92299e-10 -4.03238e-10 -1.74383e-10 -8.13296e-11 4.92183e-12];
a5=[-2.42941E-11	-2.30249E-11	-2.51809E-11	-2.75874E-11	-2.85432E-11	-2.58413E-11	-3.00184E-11
    -4.50458e-14 1.22625e-13 1.52279e-13 1.42846e-13 5.08071e-14 3.04913e-14 -8.65011e-15];
a6=[1.09926E-14	1.00123E-14	1.09536E-14	1.21091E-14	1.25009E-14	1.09383E-14	1.31142E-14
    6.72086e-18 -2.05736e-17 -2.35576e-17 -2.01726e-17 -5.34955e-18 -4.94989e-18 1.9849e-18];

bh=[600 660 760 800 860 900 1000];
b0=[6.87894E-02	1.50730E-01	4.79451E-02	2.23448E-02	-3.26391E-03	-5.14749E-02	-1.07255E-01
    23.1584 33.2732 39.1961 43.2469 49.5738 11.278 -52.6184];
b1=[-2.84077E-03	-4.00889E-03	-2.39453E-03	-1.97980E-03	-1.59869E-03	-9.21059E-04	-1.74343E-04
    -0.0802147 -0.111099 -0.12352 -0.126973 -0.138613 0.00143478 0.214689];
b2=[1.83922E-05	2.43937E-05	1.70335E-05	1.54101e-5	1.40443E-05	1.15147E-05	9.02759E-06
    0.000105824 0.000141421 0.000149015 0.000142637 0.000147851 -3.69846e-5 -0.000294882];
b3=[9.19605E-09	-9.92772E-09	-1.31626E-09	-2.35430E-09	-3.02287E-09	-1.22901e-9	-3.16512E-10
    -6.15036e-8 -7.94952e-8 -7.9705e-8 -7.09985e-8 -6.96361e-8 3.58318e-8 1.71171e-7];
b4=[-4.16873E-11	-1.82239E-11	-1.74032E-11	-1.24994E-11	-9.20160E-12	-8.13104E-12	-6.14000E-12
    1.32453e-11 1.65836e-11 1.58772e-11 1.31646e-11 1.21595e-11 -9.91225e-12 -3.60582e-11 ];

ch=[640 700 760 820 860 920 980];
c0=[-1.04825E+00	-9.31060E-01	-8.20867E-01        -7.44047E-01	-7.22471E-01	-6.87482E-01	-7.39984E-01
    50.5034         61.624          53.2623             18.2236         -31.8442        -48.7208        -147.859];
c1=[1.66305E-02	1.41537E-02	1.19916E-02	1.04743E-02	9.80317E-03	9.16594E-03	9.52854E-03
    -0.170541   -0.192967   -0.144342   -0.00840024 0.168327    0.222996    0.531652];
c2=[-9.24263E-05	-7.29862E-05	-5.79835E-05	-4.78544E-05	-4.25245E-05	-3.80932E-05	-3.62727E-05
    2.17232e-4      2.28061e-4      1.4659e-4       -3.88e-5        -2.62603e-4 -3.21884e-4     -6.71937e-4]; % последнее значение в ГОСТе без точки
c3=[2.72382E-07	2.00294E-07	1.50707E-07	1.18513e-7	9.95544E-08	8.51275E-08	7.38870E-08
    -1.21902e-7 -1.18715e-7 -6.46443e-8 4.31384e-8 1.65454e-7 1.91495e-7 3.64787e-7];
c4=[-2.41355E-10	-1.62006E-10	-1.13026E-10	-8.31498E-11	-6.55175E-11	-5.29972E-11	-4.23907E-11
    2.54037e-11 2.29638e-11 1.04227e-11 -1.23832e-11 -3.69355e-11 -4.08067e-11 -7.26268e-11];

n0=[2.058 2.058 2.058 2.058 2.058 2.058 2.058];
n1=[5.887e-3 5.887e-3 5.887e-3 5.887e-3 5.887e-3 5.887e-3 5.887e-3];
n2=[-4.012e-6 -4.012e-6 -4.012e-6 -4.012e-6 -4.012e-6 -4.012e-6 -4.012e-6];

fi1=[0.5411 0.5515 0.5585 0.5585 0.5585 0.5585 0.5585];

dh=[1500 1500 1500 1500 1500 1500 1500];
d0=[-3.51899E-01	-4.78130E-02	2.09810E-01	2.65174E-01	2.30470E-01	1.70074E-01	8.81410E-02
    -0.351899 -0.047813 0.20981 0.265174 0.23047 0.170074 0.088141];
d1=[5.77056E-03	3.80813E-03	2.62881E-03	2.75836E-03	3.38331E-03	4.06131E-03	4.68253E-03
    0.00577056 0.00380813 0.00262881 0.00275836 0.00338331 0.00406131 0.00468253];
d2=[9.95819E-07	4.22771E-06	4.24379E-06	2.08668E-06	-5.52305E-07	-2.82114E-06	-4.24609E-06
    9.95819e-7 4.22771e-6 4.24379e-6 2.08668e-6 -5.52305e-7 -2.82114e-6 -4.24609e-6];
d3=[-7.25324E-09	-8.66826E-09	-6.67328E-09	-3.69543E-09	-8.23607E-10	1.38369E-09	2.53509E-09
    -7.25324e-9 -8.66826e-9 -6.67328e-9 -3.69543e-9 -8.23607e-10 1.38369e-9 2.53509e-9];
d4=[2.97590E-12	3.06712E-12	2.13496E-12	1.11862E-12	2.21349E-13	-4.27908E-13	-7.29031E-13
    2.9759e-12 3.06712e-12 2.13496e-12 1.11862e-12 2.21349e-13 -4.27908e-13 -7.29031e-13];

eh=[600 700 780 800 800 900 760];
e0=[-7.31596E-01	-7.52175E-01	-5.70476E-01	-9.49573E-01	-9.67598E-01	-1.02278E+00	-7.57903E-01
    38.6199 51.249 68.4746 58.422 7.20188 21.5948 -88.4076];
e1=[5.97345E-03	5.65925E-03	2.958020E-3	8.13121E-03	8.41991E-03	9.23633E-03	6.06068E-03
    -0.132147 -0.167373 -2.15659e-1 -1.66664e-1 2.16109e-2 -2.02239e-2 0.338518];
e2=[-5.82037E-06	1.80820E-06	1.68896E-05	-3.878130E-6	-3.58500E-06	-6.10128E-06	7.85296E-06
    1.75411e-4 2.11832e-4 2.62273e-4 1.85486e-4 -6.52882e-5 -1.72029e-5 -0.000445581];
e3=[6.84634E-08	3.33822E-08	-4.74750E-09	2.37694E-08	1.74801E-08	1.78211E-08	-9.74891E-09
    -1.02417e-7 -1.18221e-7 -1.40972e-7 -9.12345e-8 5.37077e-8 2.83017e-8 2.51729e-7];
e4=[-9.50483E-11	-5.13965E-11	-1.72711E-11	-2.77469E-11	1.96221E-11	-1.70073E-11	1.58377E-12
    2.21446e-11 2.45055e-11 2.82285e-11 1.67118e-11 -1.4095e-11 -8.94486e12 -5.203e-11];
e5=[-2.06700E-01	-1.69710E-01	-1.46710E-01	-1.31500E-01	-1.20916E-01	-1.13630E-01	-1.04440E-01
    -0.20670 -0.16971 -0.14671 -0.13150 -0.120916 -0.11363 -0.10444];
e6=[9.75330E-02	7.98300E-02	6.88080E-02	6.16030E-02	5.65380E-02	5.31780E-02	4.85510E-02
    9.7533e-2 7.9830e-2 6.8808e-2 6.1603e-2 5.6538e-2 5.3178e-2 4.8551e-2];
e7=[-1.18170E-02	-9.43930E-03	-7.98360E-03	-7.08660E-03	-6.43240E-03	-6.04360E-03	-5.35670E-03
    -1.1817e-2 -9.4393e-3 -7.9836e-3 -7.0866e-3 -6.4324e-3 -6.0439e-3 -5.3567e-3];
e8=[1.61450E-03	1.26220E-03	1.05350E-03	9.28130E-04	8.37230E-04	7.79820E-04	6.88090E-04
    1.6145e-3 1.2622e-3 1.0535e-3 9.2813e-4 8.3723e-4 7.7982e-4 6.8809e-4];
lh=[640 660 740 800 860 900 900];
l0=[-4.07768E-01	-9.02739E-01	-7.33037E-01	-1.31444E+00	-1.20026E+00	-1.52158E+00	-1.67664E+00
    48.6536 54.4867 60.1267 47.0996 50.6174 8.01942 -15.5728];
l1=[1.48506E-03	8.26803E-03	5.23396E-03	1.33124E-02	1.14087E-02	1.57040E-02	1.77194E-02
    -0.170291 -0.178298 -0.183144 -0.12526 -0.129047 0.0185302 9.36704e-2];
l2=[1.253576E-5	-1.25448E-05	6.35667E-06	-2.55585E-05	-1.47324E-05	-3.02859E-05	-3.69498E-05
    2.26242e-4 2.22725e-4 2.12481e-4 1.26352e-4 1.24842e-4 -6.14733e-5 -1.490366e-4];
l3=[3.77311E-08	6.12853E-08	1.09065E-08	5.43981E-08	2.78040E-08	4.57668E-08	5.09134E-08
    -1.32032e-7 -1.227e-7 -1.08497e-7 -5.51584e-8 -5.24993e-8 4.97674e-8 9.42151e-08];
l4=[-7.78953E-11	-7.07966E-11	-2.61427E-11	-4.33784E-11	-2.26320E-11	-2.82926E-11	-2.82878E-11
    2.85193e-11 2.51316e-11 2.0571e-11 8.75272e-12 8.08282e-12 -1.26162e-11 -2.0961e-11];

% Выбор высотного диапазона для каждого набора коэффициентов:
[~,ia] = max([ah(i),h]);
[~,ib] = max([bh(i),h]);
[~,ic] = max([ch(i),h]);
[~,id] = max([dh(i),h]);
[~,ie] = max([eh(i),h]);
[~,il] = max([lh(i),h]);


% Планетарный среднесуточный индекс геомагнитной возмущенности с линейной
% шкалой, 2 нанотесла (2 гамма)
A0=-2.53418e-2;
A1=-2.44075e-3;
A2=3.08389e-6;
A3=2.90115e-6;
A4=-4.99606e-8;
A5=3.36327e-10;
A6=-1.0966e-12;
A7=1.73227e-15;
A8=-1.06271e-18;
% Плотность ночной атмосферы на высоте 120 км, кг/м3
Rho0=1.58868e-8;
% Влияние полугодового эффекта
A=A0+A1*d+A2*d^2+A3*d^3+A4*d^4+A5*d^5+A6*d^6+A7*d^7+A8*d^8;


beta=rtasc-Snew+fi1(i);
cosfi=1/norm(r)*(r(3)*sin(decl)+cos(decl)*(r(1)*cos(beta)+r(2)*sin(beta)));

% % Из-за ошибок округления cos(fi) быть > 1, введем ограничение
% if (abs(cosfi)-1)>1e-4
% 	disp('Something wrong in cos(fi)')
% 	return;
% elseif (abs(cosfi)-1)>0
% 	cosfi=sign(cosfi);
% end

RhoN=Rho0*exp(a0(ia,i)+a1(ia,i)*h+a2(ia,i)*h^2+a3(ia,i)*h^3+a4(ia,i)*h^4+a5(ia,i)*h^5+a6(ia,i)*h^6);

K0a = l0(il,i)+l1(il,i)*h+l2(il,i)*h^2+l3(il,i)*h^3+l4(il,i)*h^4;
K0 = 1 + K0a * (F81-F0(i))/F0(i);

K1a = c0(ic,i)+c1(ic,i)*h+c2(ic,i)*h^2+c3(ic,i)*h^3+c4(ic,i)*h^4;
K1 = K1a * (sqrt(0.5+0.5*cosfi))^(n0(i)+n1(i)*h+n2(i)*h^2);
%K1 = K1a * cosfi^(n0(i)+n1(i)*h+n2(i)*h^2)/2

K2a = d0(id,i)+d1(id,i)*h+d2(id,i)*h^2+d3(id,i)*h^3+d4(id,i)*h^4;
K2 = K2a * A;

K3a = b0(ib,i)+b1(ib,i)*h+b2(ib,i)*h^2+b3(ib,i)*h^3+b4(ib,i)*h^4;
K3 = K3a * (F107-F81)/(F81+abs(F107-F81));

K4a = e0(ie,i)+e1(ie,i)*h+e2(ie,i)*h^2+e3(ie,i)*h^3+e4(ie,i)*h^4;
K4b = e5(ie,i)+e6(ie,i)*Kp+e7(ie,i)*Kp^2+e8(ie,i)*Kp^3;
K4 = K4a * K4b;

%K0 = 1;
%K1 = 0;

KK = [K0, K1, K2, K3, K4];

Rho=RhoN*K0*(1+K1+K2+K3+K4);

if Rho > 1e-3
    Rho = 1e-3;
    fprintf('>1e-3\n');
end

if Rho < 0
    Rho = 0;
    %fprintf('<0\n');
end

end